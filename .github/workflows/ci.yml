name: CI

on:
  workflow_dispatch:
  push:
    branches: ["3.7"]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: ["3.7"]

# See https://docs.github.com/en/actions/using-jobs/using-concurrency#example-using-a-fallback-value
concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CHANNEL: "3.7"
  ICE_VERSION: "3.7.11"

jobs:
  ci:
    name: ${{ matrix.os }} (${{ matrix.quality }})
    strategy:
      fail-fast: false
      matrix:
        # TODO add stable once 3.7.11 packages are released
        quality: [nightly]
        os: [ubuntu-24.04, macos-26, windows-2022]

    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.x

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "oracle"
          java-version: "17"

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        if: runner.os == 'Windows'
        with:
          msbuild-architecture: x64

      - name: Install Ice
        uses: ./.github/actions/install-ice
        with:
          channel: ${{ env.CHANNEL }}
          quality: ${{ matrix.quality }}

      - name: Configure Nightly Feeds
        if: matrix.quality == 'nightly'
        shell: bash
        run: |
          python scripts/setup-nightly.py --github-env "$GITHUB_ENV" --channel "${CHANNEL}"

      - name: Set ICE_HOME and MAKEFLAGS
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            echo "ICE_HOME=/usr" >> "$GITHUB_ENV"
            echo "MAKEFLAGS=-j $(nproc)" >> "$GITHUB_ENV"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "ICE_HOME=/opt/homebrew" >> "$GITHUB_ENV"
            echo "MAKEFLAGS=-j $(sysctl -n hw.ncpu)" >> "$GITHUB_ENV"
          elif [[ "$RUNNER_OS" == "Windows" ]]; then
            echo "ICE_HOME=C:\Program Files\ZeroC\Ice-${ICE_VERSION}" >> "$GITHUB_ENV"
          fi

      - name: Build C++ Demos
        if: runner.os != 'Windows'
        timeout-minutes: 20
        env:
          WARNINGS_AS_ERRORS: "yes"
        run: |
          make V=1 -C cpp98
          make V=1 -C cpp11

      - name: Build C++ Demos
        if: runner.os == 'Windows'
        timeout-minutes: 20
        env:
          WARNINGS_AS_ERRORS: "yes"
        run: |
          nuget restore "cpp98\C++98 demos.sln"
          msbuild "cpp98\C++98 demos.sln" /m /p:Configuration=Release /p:Platform=x64
          nuget restore "cpp11\C++11 demos.sln"
          msbuild "cpp11\C++11 demos.sln" /m /p:Configuration=Release /p:Platform=x64

      - name: Build Objective-C Demos
        if: runner.os == 'macOS'
        timeout-minutes: 20
        run: |
          make V=1 -C objective-c

      - name: Build Swift Demos
        if: runner.os == 'macOS'
        timeout-minutes: 20
        run: |
          SHARED_BUILD_DIR="${PWD}/swift/.build"
          find swift -name Package.swift -exec dirname {} \; | sort | while read -r demo; do
            echo "Building $demo..."
            make -C "$demo" slice
            (cd "$demo" && swift build -c release --scratch-path "$SHARED_BUILD_DIR")
          done

      - name: Build SwiftUI Demos
        if: runner.os == 'macOS'
        timeout-minutes: 20
        run: |
          xcodebuild -project swift/Ice/helloUI/helloUI.xcodeproj -scheme helloUI -destination 'generic/platform=iOS Simulator' build
          xcodebuild -project swift/IceDiscovery/helloUI/helloUI.xcodeproj -scheme helloUI -destination 'generic/platform=iOS Simulator' build

      - name: Build C# Demos
        timeout-minutes: 20
        working-directory: csharp
        run: |
          dotnet build /p:TreatWarningsAsErrors=true

      - name: Build Java Demos
        timeout-minutes: 20
        working-directory: java
        shell: bash
        run: |
          ./gradlew build -PdevRepo="${MAVEN_REPO}" -PiceHome="${ICE_HOME}" -PiceArtifactVersion="${ICE_VERSION}+"

      - name: Build Java Compat Demos
        timeout-minutes: 20
        working-directory: java-compat
        shell: bash
        run: |
          ./gradlew build -PdevRepo="${MAVEN_REPO}" -PiceHome="${ICE_HOME}" -PiceArtifactVersion="${ICE_VERSION}+"

      - name: Build JavaScript Demos
        timeout-minutes: 20
        working-directory: js
        run: |
          npm install
          npx gulp build

      - name: Build TypeScript Browser Demos
        timeout-minutes: 20
        working-directory: typescript/browser
        run: |
          npm install
          npx gulp build

      - name: Build TypeScript Node.js Demos
        timeout-minutes: 20
        working-directory: typescript/nodejs
        run: |
          npm install
          npx gulp build

  docker-ci:
    name: ${{ matrix.distro }} (docker)
    strategy:
      fail-fast: false
      matrix:
        distro: [ubuntu22.04, ubuntu24.04, debian12, debian13, rocky9, rocky10, amzn2023]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -f docker/${{ matrix.distro }}/Dockerfile -t ice-demos-${{ matrix.distro }}:test docker

      - name: Build C++ Demos
        timeout-minutes: 30
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/ice-demos \
            -w /ice-demos \
            ice-demos-${{ matrix.distro }}:test \
            bash -l -c "make -C cpp98 && make -C cpp11"
